\IfFileExists{lucimatx.sty}{
  % ----- if Lucida availalable------------------
  \usepackage[
    scale=0.875,
    stdmathitalics=true,
    stdmathdigits=true]{lucimatx}
 \linespread{1.02}
}{
  % ------ if Lucida not available --------------
  \usepackage{times}
  \usepackage{amssymb}
}

%suppress underfull hbox warnings by setting hbadness to max
\hbadness=10000

\usepackage{makeidx}
\makeindex

% \usepackage{index}
% \newindex{funs}{fdx}{fns}{Functions}

\usepackage[T1]{fontenc} % needed for |
\usepackage{amsmath}
\usepackage{xspace}
\usepackage{fancyvrb}
%\usepackage{fancyhdr}
\usepackage{titlesec}
\usepackage{graphicx}
\usepackage{natbib}
\usepackage{url}
\usepackage{changebar}
\usepackage{upquote}
\usepackage{alltt}
\usepackage{lscape}
\usepackage{relsize} % defines \mathlarger

\usepackage[titles]{tocloft}
\setlength{\cftbeforechapskip}{1ex}
\setlength{\cftbeforesecskip}{1ex}
\renewcommand{\cftchapfont}{\normalsize\rm}
\renewcommand{\cftchappagefont}{\normalsize\rm}
\renewcommand{\cftpartfont}{\normalsize\rm\bfseries}
\renewcommand{\cftpartpagefont}{\normalsize\rm\bfseries}
\renewcommand{\cftchapaftersnum}{.}
\renewcommand{\cftchapaftersnumb}{\hspace*{8pt}}
\renewcommand{\@pnumwidth}{5em}
\renewcommand{\@tocrmarg}{4em}
\setcounter{tocdepth}{0}


\titleformat{\chapter}{\bfseries\LARGE}{\thechapter.}{1.5pc}{}{}%{1.5pc}{}{}
\titlespacing{\chapter}{0pt}{-24pt}{12pt}{}
%
\titleformat{\section}{\bfseries\large}{\thesection.}{1em}{}
%\titlespacing{\section}{0pt}{12pt}{6pt}
%
\titleformat{\subsection}{\bfseries}{}{0em}{}
%\titlespacing{\subsection}{-1em}{12pt}{6pt}
\titleformat{\subsubsection}{\slshape}{}{0em}{}
%\titlespacing{\subsection}{-1em}{12pt}{6pt}

\usepackage{xcolor}
\definecolor{linkcolor}{RGB}{0,0,128}
\usepackage[pagebackref,pdfpagelabels,plainpages=false,hypertexnames=true,colorlinks=true,linkcolor=linkcolor,anchorcolor=linkcolor,citecolor=linkcolor,filecolor=linkcolor,menucolor=linkcolor,runcolor=linkcolor,urlcolor=linkcolor,pdfborder={0 0 0}]{hyperref}


% BG: Stuff for changed text
\usepackage[final,author=]{fixme}
\fxuselayouts{pdfcmargin}
\fxusetargetlayout{changebar}
\newcommand{\A}[1]{\cbstart#1\cbend}
\newcounter{FXNOTE}[page]
\newcommand{\FXA}[1][\value{FXNOTE}]{\ifnum#1=0\fxnote{Addition to section \thesection}\stepcounter{FXNOTE}\fi}
\newcommand{\FXC}[1][\value{FXNOTE}]{\ifnum#1=0\fxnote{Change to section \thesection}\stepcounter{FXNOTE}\fi}
\renewcommand\englishlistfixmename{List of changes}

\newcommand{\stanc}{{\ttfamily stanc}\xspace}
\newcommand*{\Cpp}{C\raise.15ex\hbox{\footnotesize ++}\xspace} %\ensuremath{++}
\newcommand{\clang}{{\ttfamily clang\raise.2ex\hbox{\footnotesize ++}}\xspace}
\newcommand{\gpp}{{\ttfamily g\raise.2ex\hbox{\footnotesize ++}}\xspace}

\newcommand{\acronym}[1]{#1\xspace}

\newcommand{\ASCII}{\acronym{ASCII}}
\newcommand{\BNF}{\acronym{BNF}}
\newcommand{\MATLAB}{\acronym{MATLAB}}
\newcommand{\R}{\acronym{R}}
\newcommand{\SPLUS}{\acronym{S}}
\newcommand{\BUGS}{\acronym{BUGS}}
\newcommand{\JAGS}{\acronym{JAGS}}
\newcommand{\MCMC}{\acronym{MCMC}}
\newcommand{\HMC}{\acronym{HMC}}
\newcommand{\NUTS}{\acronym{NUTS}}
\newcommand{\MSVC}{\acronym{MSVC}}
\newcommand{\LKJ}{\acronym{LKJ}}
\newcommand{\CPC}{\acronym{CPC}}

\newcommand{\code}[1]{{\tt #1}}
\newcommand{\mycaption}[2]{\caption{{\it #2}\label{#1.figure}}}

\newcommand{\distro}[1]{\mbox{\sf #1}}
\newcommand{\Betafun}{\mbox{B}}
\newcommand{\setlist}[1]{\{ #1 \}}
\newcommand{\reals}{\mathbb{R}}
\newcommand{\posreals}{\mathbb{R}^+}
\newcommand{\nats}{\mathbb{N}}
\newcommand{\bigo}[1]{{\mathcal{O}}(#1)}
\newcommand{\erfc}[1]{\operatorname{erfc}#1}
\newcommand{\erf}[1]{\operatorname{erf}#1}
\newcommand{\sech}[1]{\operatorname{sech}#1}

% math macros for variational inference
\newcommand{\KL}[2]{\ensuremath{\textrm{KL}\left[#1\;\|\;#2}\right]}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\newcommand{\E}{\mathbb{E}}

\newcommand{\ternary}[3]{#1 \ ? \ #2 \ : \ #3}

\newcommand{\refappendix}[1]{Appendix~\ref{#1.appendix}}
\newcommand{\refpart}[1]{Part~\ref{#1.part}}
\newcommand{\refchapter}[1]{Chapter~\ref{#1.chapter}}
\newcommand{\refsection}[1]{Section~\ref{#1.section}}
\newcommand{\reffigure}[1]{Figure~\ref{#1.figure}}
\newcommand{\refnote}[1]{Footnote~\ref{#1.footnote}}
\newcommand{\refequation}[1]{Equation~(\ref{#1.equation})}


% \textwidth = 5in
\newcommand{\fitem}[4]{\item[\begin{minipage}{4.9in}{\tt #1 {\bfseries #2}(#3)}\end{minipage}]\mbox{ }
  \\[-10pt] #4\index{{\tt\bfseries #2 }!{\tt (#3):\,#1}|hyperpage}}

\newcommand{\fitemnobody}[3]{\item[\begin{minipage}{4.9in}{\tt #1 {\bfseries #2}(#3)}\end{minipage}]\mbox{ }
 \\[-30pt]\index{{\tt\bfseries #2 }!{\tt (#3):\,#1}|hyperpage}}

\newcommand{\fitemtwolines}[5]{\item[\begin{minipage}{4.9in}{\tt
      #1 {\bfseries #2}(#3, \\ \hspace*{60pt}#4\vspace*{8pt})}\end{minipage}]\mbox{ }
  \\[-10pt] #5\index{{\tt\bfseries #2 }!{\tt (#3 #4):\,#1}|hyperpage}}

\newcommand{\fitemthreelines}[6]{\item[\begin{minipage}{4.9in}{\tt
      #1 {\bfseries #2}(#3, \\ \hspace*{60pt}#4, \\ \hspace*{60pt}#5\vspace*{8pt})}\end{minipage}]\mbox{ }
 \\[-10pt] #6\index{{\tt\bfseries #2 }!{\tt (#3, #4, #5):\,#1}|hyperpage}}

\newcommand{\fitemfourlines}[7]{\item[\begin{minipage}{4.9in}{\tt
      #1 {\bfseries #2}(#3, \\ \hspace*{60pt}#4, \\ \hspace*{60pt}#5, \\ \hspace*{60pt}#6\vspace*{8pt})}\end{minipage}]\mbox{ }
 \\[-10pt] #7\index{{\tt\bfseries #2 }!{\tt (#3, #4, #5, #6):\,#1}|hyperpage}}


\newcommand{\fitemindex}[5]{\item[\begin{minipage}{4.9in}{\tt #1 {\bfseries #2}(#3)}\end{minipage}]\mbox{ }
  \\[-10pt] #4\index{{\tt\bfseries #5 }!{\tt (#3):\,#1}|hyperpage}}
\newcommand{\fitemindexnobody}[4]{\item[\begin{minipage}{4.9in}{\tt #1 {\bfseries #2}(#3)}\end{minipage}]\mbox{ }
  \\[-30pt] \index{{\tt\bfseries #4 }!{\tt (#3):\,#1}|hyperpage}}


\newcommand{\fitemUnaryVec}[3]{
  \fitem{R}{#1}{T \farg{x}}{Returns the (elementwise) #2, #3
    for any argument type \code{T};  see
    \refsection{fun-vectorization} for details including return type
    \code{R}.}
}
\newcommand{\fitemUnaryVecSort}[4]{
  \fitemindexsort{R}{#1}{T \farg{x}}{Returns the (elementwise) #2, #3
    for any argument type \code{T};  see
    \refsection{fun-vectorization} for details including return type
    \code{R}.}{#1}{#4}
}


\newcommand{\fitemindexsort}[6]{\item[{\tt #1 {\bfseries #2}(#3)}]\mbox{ }
  \\[2pt] #4\index{{\tt\bfseries #6 }@{\tt\bfseries #5 }!{\tt
      (#3):\,#1}|hyperpage}}

\newcommand{\indexref}[2]{\index{{\tt\bfseries #1}@{\tt #1}|see {#2}}}

\newcommand{\farg}[1]{{\tt\slshape #1}}

\newcommand{\pitemImpl}[4]{\subsubsection{Sampling Statement}
\begin{description}
\item {\tt \farg{#1} \textasciitilde\ {\bfseries #2}(\farg{#3});}
  \\
  Increment log probability with {\tt #2\_#4(\farg{#1} \textbar\ \farg{#3})},
  dropping constant additive terms; \refsection{sampling-statements}
  explains sampling statements.%
\index{{\tt\bfseries #2 }!sampling statement|hyperpage}
\end{description}}

\newcommand{\pitem}[3]{\pitemImpl{#1}{#2}{#3}{lpdf}}
\newcommand{\pitemdisc}[3]{\pitemImpl{#1}{#2}{#3}{lpmf}}

\newcommand{\indentarrow}{ \rotatebox[origin=c]{180}{\ensuremath{\Lsh}} }

\newcommand{\hiershortcmd}[3]{\item[#1 \tt #2] \mbox{ } \\ #3}
\newcommand{\hierlongcmd}[4]{\item[#1 \tt #2] \mbox{ } \\ #3 \\ #4}
\newcommand{\hiercmdarg}[6]{\item[#1 \tt #2={\slshape <#3>}] \mbox{ } \\ #4 \\ #5 \\ (#6)}

\newcommand{\shortcmd}[2]{ \hiershortcmd{}{#1}{#2} }
\newcommand{\longcmd}[3]{ \hierlongcmd{}{#1}{#2}{#3} }
\newcommand{\cmdarg}[5]{ \hiercmdarg{}{#1}{#2}{#3}{#4}{#5} }

\newcommand{\samp}{{\lower.78ex\hbox{\texttt{\char`\~}}}}%
%{{\lower1.1ex\hbox{\Large\texttt{\char`\~}}}}

% iPad: 3w x 4h,

\setlength{\paperwidth}{6in}
\setlength{\paperheight}{8in}
\pdfpagewidth=\paperwidth
\pdfpageheight=\paperheight

\setlength{\textwidth}{5in}
\setlength{\textheight}{6.875in}
\setlength{\oddsidemargin}{-0.5in}
\setlength{\evensidemargin}{-0.5in}
\setlength{\topmargin}{-0.875in}
\setlength{\headsep}{18pt}

\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\floatpagefraction}{0.75}
\renewcommand{\textfraction}{0.07}


% environment for Stan code
\DefineVerbatimEnvironment{stancode}{Verbatim}{fontsize=\small,xleftmargin=2em}

\raggedbottom

\sloppy % no line overruns

